name: CI

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  MACOSX_DEPLOYMENT_TARGET: '10.13'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Jobs are grouped by package
jobs:
  biome-lint:
    name: Biome Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Biome
        uses: biomejs/setup-biome@v2

      - name: Run Biome
        run: biome ci . --css-parse-tailwind-directives=true

  test-rust:
    name: Rust Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          binstall: cargo-audit,cargo-llvm-cov,cargo-rdme
          components: rustfmt,clippy
          stage: test

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: CARGO_PROFILE_TEST_STRIP="debuginfo" cargo test

      - name: Setup Biome
        uses: biomejs/setup-biome@v2

      - name: Run Biome
        run: biome check --write --unsafe .

      # make sure cargo test didn't change any files (like TypeScript bindings)
      - name: Check for git changes and prepare artifact
        id: check_changes
        run: |
          changed_files=$(git diff --name-only HEAD -- || true)
          if [ -n "$changed_files" ]; then
            echo "Warning: The following files were modified during the build:"
            echo "$changed_files"
            echo ""
            echo "This usually happens when generated files (like TypeScript bindings) are not committed."
            echo "These files will be uploaded as artifacts before the CI fails."
            echo "$changed_files" > changed_files.txt
            # Create a tarball of the changed files from HEAD so we capture committed content
            git archive --output=changed_files.tar.gz HEAD $(git diff --name-only HEAD --)
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "No files were modified during the build."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload changed files artifact
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: changed-files
          path: changed_files.tar.gz
          if-no-files-found: error

      - name: Fail if files were changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "Error: The following files were modified during the build process:"
          echo ""
          cat changed_files.txt
          echo ""
          echo "The changed files have been uploaded as artifacts for review."
          echo "Please commit these changes or update the generation scripts."
          exit 1

      - name: Test README.md is up to date
        working-directory: takumi
        run: cargo rdme --check

      - name: Run security audit
        run: cargo audit

      - name: Test Publish (--dry-run)
        working-directory: takumi
        run: cargo publish --dry-run

  build-helpers:
    name: Build @takumi-rs/helpers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-helpers
      
      - name: Test
        working-directory: takumi-helpers
        run: bun test

      - name: Build helpers
        working-directory: takumi-helpers
        run: bun run build

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: helpers-dist
          path: takumi-helpers/dist
          if-no-files-found: error

  test-helpers:
    name: Test @takumi-rs/helpers
    runs-on: ubuntu-latest
    needs: build-helpers
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-helpers

      - name: Test
        working-directory: takumi-helpers
        run: bun test

  build-napi:
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-2025
            target: x86_64-pc-windows-msvc
            build: bun run build --target x86_64-pc-windows-msvc
            # `windows-11-arm` is available, but bun does not have ARM64 support yet https://github.com/oven-sh/bun/issues/9824
          - host: windows-2025
            target: aarch64-pc-windows-msvc
            build: bun run build --target aarch64-pc-windows-msvc
          - host: macos-15
            target: aarch64-apple-darwin
            build: bun run build --target aarch64-apple-darwin
          - host: macos-15-intel
            target: x86_64-apple-darwin
            build: bun run build --target x86_64-apple-darwin
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            build: bun run build --target aarch64-unknown-linux-gnu --use-napi-cross
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            build: bun run build --target aarch64-unknown-linux-musl -x
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            # --use-napi-cross is required to pin libc version at 2.31 (from cross-rs docs)
            build: bun run build --target x86_64-unknown-linux-gnu --use-napi-cross
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: bun run build --target x86_64-unknown-linux-musl -x

    name: Build @takumi-rs/core for ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{ matrix.settings.target }}
          stage: build

      - name: Install cargo-zigbuild
        if: ${{ contains(matrix.settings.target, 'musl') }}
        run: pip install cargo-zigbuild

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-napi-core

      - name: Build
        working-directory: takumi-napi-core
        run: ${{ matrix.settings.build }}

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: bindings-${{ matrix.settings.target }}
          path: |
            takumi-napi-core/core.*.node
            takumi-napi-core/index.js
            takumi-napi-core/index.d.ts
          if-no-files-found: error

  build-image-response:
    name: Build @takumi-rs/image-response
    runs-on: ubuntu-latest
    needs: [build-helpers, build-napi]
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download N-API bindings artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: takumi-napi-core

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-image-response

      - name: Build image-response
        working-directory: takumi-image-response
        run: bun run build

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: image-response-dist
          path: takumi-image-response/dist
          if-no-files-found: error

  test-image-response:
    name: Test @takumi-rs/image-response
    runs-on: ubuntu-latest
    needs: build-image-response
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download N-API bindings artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: takumi-napi-core

      - name: Download image-response artifact
        uses: actions/download-artifact@v6
        with:
          name: image-response-dist
          path: takumi-image-response/dist

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-image-response

      - name: Test image-response
        working-directory: takumi-image-response
        run: bun test

  build-template:
    name: Build @takumi-rs/template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-template

      - name: Build template
        working-directory: takumi-template
        run: bun run build

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: template-dist
          path: takumi-template/dist
          if-no-files-found: error

  test-template:
    name: Test @takumi-rs/template
    runs-on: ubuntu-latest
    needs: [build-template, build-napi]
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download N-API bindings artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: takumi-napi-core

      - name: Download template artifact
        uses: actions/download-artifact@v6
        with:
          name: template-dist
          path: takumi-template/dist

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-template

      - name: Test template
        working-directory: takumi-template
        run: bun test

  test-napi:
    needs: build-napi
    name: Test @takumi-rs/core for ${{ matrix.settings.target }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-2025
            target: x86_64-pc-windows-msvc
          # Windows ARM64 can be built atm, but since bun does not have ARM64 support yet https://github.com/oven-sh/bun/issues/9824,
          # we don't test it.
          # - host: windows-11-arm
          #   target: aarch64-pc-windows-msvc
          - host: macos-15-intel
            target: x86_64-apple-darwin
            build: bun run build --target x86_64-apple-darwin
          - host: macos-15
            target: aarch64-apple-darwin
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-napi-core

      - name: Download N-API bindings artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-${{ matrix.settings.target }}
          path: takumi-napi-core

      - name: List packages
        run: ls -R .
        working-directory: takumi-napi-core

      - name: Test bindings
        if: ${{ !contains(matrix.settings.target, 'musl') }}
        working-directory: takumi-napi-core
        run: bun test

      - name: Test bindings in Alpine (musl)
        if: contains(matrix.settings.target, 'musl')
        run: |
          docker run --rm -v $PWD:/workspace -w /workspace/takumi-napi-core \
            oven/bun:alpine bun test

  build-wasm:
    name: Build @takumi-rs/wasm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: wasm32-unknown-unknown
          stage: build

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM
        working-directory: takumi-wasm
        run: bun run build

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: wasm-package
          path: |
            takumi-wasm/pkg/*
          if-no-files-found: error
    
  test-wasm:
    name: Test @takumi-rs/wasm
    needs: [build-wasm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: wasm-package
          path: takumi-wasm/pkg

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./takumi-wasm

      - name: Test WASM
        working-directory: takumi-wasm
        run: bun test

  pass-test:
    name: Pass Test
    runs-on: ubuntu-latest
    needs: [biome-lint, test-rust, test-helpers, test-napi, test-image-response, test-template, test-wasm]
    steps:
      - name: Pass test
        run: echo "Pass test"

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: pass-test
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5

      - name: Install cargo-edit
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-edit

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          stage: release
          components: clippy,rustfmt
      
      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download all napi artifacts
        uses: actions/download-artifact@v6
        with:
          path: takumi-napi-core/artifacts

      - name: Download image-response artifact
        uses: actions/download-artifact@v6
        with:
          name: image-response-dist
          path: takumi-image-response/dist

      - name: Download template artifact
        uses: actions/download-artifact@v6
        with:
          name: template-dist
          path: takumi-template/dist

      - name: Download WASM artifact
        uses: actions/download-artifact@v6
        with:
          name: wasm-package
          path: takumi-wasm/pkg

      - name: Install dependencies
        run: bun install --frozen-lockfile && echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH

      # Trusted publishing requires npm 11.5.1
      - name: Update npm version 
        run: bun install -g npm@latest

      - uses: rust-lang/crates-io-auth-action@v1
        id: crates-io-auth

      - name: Create Release Pull Request or Publish
        uses: changesets/action@v1
        with:
          version: bun version
          publish: bun release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-io-auth.outputs.token }}
          NPM_TOKEN: '' # https://github.com/changesets/changesets/issues/1152#issuecomment-3190884868
          NPM_CONFIG_PROVENANCE: true
          
  deploy-docs:
    name: Deploy docs
    runs-on: ubuntu-latest
    needs: pass-test
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download N-API bindings artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: takumi-napi-core

      - name: Download image-response artifact
        uses: actions/download-artifact@v6
        with:
          name: image-response-dist
          path: takumi-image-response/dist

      - name: Download template artifact
        uses: actions/download-artifact@v6
        with:
          name: template-dist
          path: takumi-template/dist

      - name: Download helpers artifact
        uses: actions/download-artifact@v6
        with:
          name: helpers-dist
          path: takumi-helpers/dist

      - name: Download template artifact
        uses: actions/download-artifact@v6
        with:
          name: template-dist
          path: takumi-template/dist

      - name: Download WASM artifact
        uses: actions/download-artifact@v6
        with:
          name: wasm-package
          path: takumi-wasm/pkg

      - name: Install dependencies
        run: bun install --frozen-lockfile --filter ./docs

      - name: Build docs
        working-directory: docs
        run: bun run build

      - name: Deploy to Cloudflare Pages
        if: github.ref == 'refs/heads/master'
        uses: cloudflare/wrangler-action@v3
        with:
          command: pages deploy docs/build/client --project-name takumi
          apiToken: ${{ secrets.CF_DOCS_PAGES_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
